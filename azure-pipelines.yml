# ASP.NET Core
# Build and test ASP.NET Core projects targeting .NET Core.
# Add steps that run tests, create a NuGet package, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

pool:
  vmImage: ubuntu-latest

variables:
- name: buildConfiguration
  value: 'Release'

pr: none

# Always trigger a run when changes are made to the license test implementation or baselines
trigger: 
  branches:
    include:
    # Add comment
    - main

stages:
- stage: A
  jobs:
  - job: A1
    steps:
    - bash: |
        set -x
        cd $(Build.StagingDirectory)
        adir=src/arcade/artifacts/buildLogs/log/Release
        mkdir -p ${adir}
        touch "${adir}/Build.binlog"
        touch "${adir}/ToolsetRestore.binlog"
        touch "${adir}/source-inner-build.binlog"

        cdir=src/cecil/artifacts/buildLogs/log/Release
        mkdir -p ${cdir}
        touch "${cdir}/Build.binlog"
        touch "${cdir}/ToolsetRestore.binlog"
        touch "${cdir}/source-inner-build.binlog"

        cdir2=src/cecil/artifacts/buildLogs/log/Debug
        mkdir -p ${cdir2}
        touch "${cdir2}/Build2.binlog"
        touch "${cdir2}/ToolsetRestore2.binlog"
        touch "${cdir2}/source-inner-build2.binlog"

        ardir=artifacts/log/Release
        mkdir -p ${ardir}
        touch "${ardir}/Build.binlog"
      displayName: Create new file
    - bash: |
        set -x
        sudo apt-get install -y rsync
        sudo apt-get clean all
      displayName: Install rsync
    - script: |
        set -x
        targetFolder=$(Build.StagingDirectory)/BuildLogs/
        mkdir -p ${targetFolder}
        echo "cd $(Build.StagingDirectory)"
        cd $(Build.StagingDirectory)
        for dir in src/*/
        do
            repoName=$(basename ${dir})
            DotNetBuildArtifactsLogDir=${targetFolder}artifacts/log/Release/${repoName}/
            mkdir /p ${DotNetBuildArtifactsLogDir}
            find src/${repoName}/artifacts/buildLogs/log/Release/ -type f -name "*.binlog" -exec rsync -a {} -t ${DotNetBuildArtifactsLogDir} \;
        done 

        echo ""
        find ${targetFolder}/ -type f -name "*.binlog"
        find src/ -type f -name "*.binlog" -exec rsync -R {} -t ${targetFolder} \;
      displayName: Copy binlog files  
    - publish: $(Build.StagingDirectory)/BuildLogs
      artifact: $(Agent.JobName)_BuildLogs_Attempt$(System.JobAttempt)
      displayName: Publish Artifacts
      continueOnError: true
